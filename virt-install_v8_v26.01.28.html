<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>KVM virt-install Generator v7 (SSH Auto-Connect)</title>
    <style>
        :root { --primary-color: #2c3e50; --accent-color: #3498db; --success-color: #27ae60; --warning-color: #f39c12; --ssh-color: #8e44ad; }
        body { font-family: 'Malgun Gothic', sans-serif; background-color: #eceff1; padding: 20px; color: #333; line-height: 1.5; }
        .container { max-width: 1000px; margin: auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        h2 { border-left: 6px solid var(--primary-color); padding-left: 15px; color: var(--primary-color); margin-bottom: 25px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 5px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 14px; }
        .flex-row { display: flex; gap: 10px; }
        .cloud-init-panel { background: #fffef0; border: 1px solid #f1e6b2; padding: 15px; border-radius: 8px; margin-top: 10px; grid-column: span 2; }
        .result-box { margin-top: 25px; border-top: 2px solid #eee; padding-top: 20px; }
        .cmd-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        textarea { width: 100%; font-family: 'Consolas', monospace; background: #1e1e1e; color: #dcdcdc; padding: 15px; border-radius: 6px; border: none; font-size: 13.5px; line-height: 1.6; resize: vertical; margin-bottom: 15px; }
        .btn-copy { background: var(--success-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-ssh { background: var(--ssh-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .radio-group { display: flex; gap: 20px; padding: 10px 0; }
        .badge { font-size: 11px; background: var(--warning-color); color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        .hint { font-size: 11px; color: #888; margin-top: 3px; display: block; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ KVM virt-install í†µí•© ìƒì„±ê¸° v7</h2>

    <div class="form-grid">
        <div class="form-group">
            <label>ê°€ìƒë¨¸ì‹  ì´ë¦„</label>
            <input type="text" id="vm_name" value="Rocky9-Auto" oninput="syncDiskPath(); generate();">
        </div>

        <div class="form-group">
            <label>OS Variant</label>
            <select id="os_variant" onchange="onOsChange()">
                <optgroup label="RedHat ê³„ì—´">
                    <option value="rocky9" selected>Rocky Linux 9.x</option>
                    <option value="rocky8">Rocky Linux 8.x</option>
                    <option value="rhel9.0">RHEL 9.x</option>
                </optgroup>
                <optgroup label="Debian/Ubuntu ê³„ì—´">
                    <option value="ubuntu24.04">Ubuntu 24.04 LTS</option>
                </optgroup>
                <optgroup label="Windows (SSH/Cloud-init ë¯¸ì§€ì›)">
                    <option value="win11">Windows 11</option>
                </optgroup>
            </select>
        </div>

        <div class="form-group">
            <label>RAM (MB) / vCPUs</label>
            <div class="flex-row">
                <input type="number" id="ram_val" value="4096" oninput="generate()" style="flex:2;">
                <input type="number" id="vcpus" value="2" oninput="generate()" style="flex:1;">
            </div>
        </div>

        <div class="form-group">
            <label>ë””ìŠ¤í¬ í¬ë§· & í¬ê¸° (GB)</label>
            <div class="flex-row">
                <select id="disk_format" onchange="syncDiskPath(); generate();" style="flex:1.5;">
                    <option value="qcow2" selected>qcow2</option>
                    <option value="img">img (raw)</option>
                </select>
                <input type="number" id="disk_size" value="20" oninput="generate()" style="flex:1;">
            </div>
        </div>

        <div class="form-group full-width" style="grid-column: span 2;">
            <label>ë””ìŠ¤í¬ ì €ì¥ ê²½ë¡œ</label>
            <input type="text" id="disk_path" value="/var/lib/libvirt/images/Rocky9-Auto.qcow2" oninput="manualDiskPath()">
        </div>

        <div class="form-group">
            <label>ë„¤íŠ¸ì›Œí¬ ë¸Œë¦¿ì§€ & ê³ ì • IP <span class="badge">í•„ìˆ˜</span></label>
            <div class="flex-row">
                <input type="text" id="net_br" value="br0" oninput="generate()" style="flex:1;">
                <input type="text" id="static_ip" value="192.168.122.200" oninput="generate()" style="flex:2;">
            </div>
            <span class="hint">* SSH ìë™ ì ‘ì†ì„ ìœ„í•´ IP ì…ë ¥ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</span>
        </div>

        <div class="form-group">
            <label>ê·¸ë˜í”½ ëª¨ë“œ</label>
            <div class="radio-group">
                <label><input type="radio" name="graphics" value="none" checked onclick="generate()"> CLI</label>
                <label><input type="radio" name="graphics" value="vnc" onclick="generate()"> VNC</label>
            </div>
        </div>

        <div class="cloud-init-panel" id="cloud_panel">
            <label style="color:#d35400; font-weight:bold;"><input type="checkbox" id="use_cloud_init" onchange="generate()" checked> â˜ï¸ Cloud-init & SSH Automation</label>
            
            <div id="cloud_details" style="margin-top:10px;">
                <div class="flex-row" style="margin-bottom:10px;">
                    <input type="text" id="cloud_user" value="rocky" placeholder="ì‚¬ìš©ì" oninput="generate()">
                    <input type="text" id="cloud_pw" value="password123!" placeholder="ë¹„ë²ˆ" oninput="generate()">
                </div>
                <label>SSH Public Key (í˜¸ìŠ¤íŠ¸ì˜ ~/.ssh/id_rsa.pub ë‚´ìš©)</label>
                <input type="text" id="ssh_key" placeholder="ssh-rsa AAAAB3Nza..." oninput="generate()">
                <span class="hint">* í‚¤ë¥¼ ë„£ìœ¼ë©´ ë¹„ë²ˆ ì—†ì´ ì¦‰ì‹œ ë¡œê·¸ì¸ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
                
                <label style="margin-top:10px;">Cloud ì´ë¯¸ì§€ URL</label>
                <input type="text" id="cloud_url" value="https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2" oninput="generate()">
            </div>
            <div id="iso_details" style="display:none; margin-top:10px;">
                <label>ISO ì„¤ì¹˜ ì†ŒìŠ¤</label>
                <input type="text" id="iso_path" value="/home/wjs/Rocky-9.3-x86_64-minimal.iso" oninput="generate()">
            </div>
        </div>
    </div>

    <div class="result-box">
        <div id="ip_update_area">
            <div class="cmd-label">
                <label>1. IP ì˜ˆì•½ ëª…ë ¹ì–´ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)</label>
                <button class="btn-copy" onclick="copyText('ip_cmd')">ë³µì‚¬</button>
            </div>
            <textarea id="ip_cmd" readonly style="height: 50px;"></textarea>
        </div>

        <div class="cmd-label">
            <label>2. VM ìƒì„± ëª…ë ¹ì–´ (virt-install)</label>
            <button class="btn-copy" onclick="copyText('virt_cmd')">ë³µì‚¬</button>
        </div>
        <textarea id="virt_cmd" readonly style="height: 300px;"></textarea>

        <div class="cmd-label">
            <label>3. â˜• SSH ìë™ ì ‘ì† ìŠ¤í¬ë¦½íŠ¸ (VM ìƒì„± í›„ ì‹¤í–‰)</label>
            <button class="btn-ssh" onclick="copyText('ssh_cmd')">ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬</button>
        </div>
        <textarea id="ssh_cmd" readonly style="height: 150px; background: #2c3e50; color: #ecf0f1;"></textarea>
    </div>
</div>

<script>
    let isManualPath = false;
    const cloudImages = {
        'rocky9': 'https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2',
        'rocky8': 'https://dl.rockylinux.org/pub/rocky/8/images/x86_64/Rocky-8-GenericCloud-Base.latest.x86_64.qcow2',
        'ubuntu24.04': 'https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img'
    };

    function syncDiskPath() {
        if (!isManualPath) {
            const name = document.getElementById('vm_name').value || "VM";
            const format = document.getElementById('disk_format').value;
            document.getElementById('disk_path').value = `/var/lib/libvirt/images/${name}.${format}`;
        }
    }

    function manualDiskPath() { isManualPath = true; generate(); }

    function onOsChange() {
        const os = document.getElementById('os_variant').value;
        if(os.startsWith('win')) {
            document.getElementById('cloud_panel').style.display = 'none';
            document.getElementById('use_cloud_init').checked = false;
            document.querySelector('input[name="graphics"][value="vnc"]').checked = true;
        } else {
            document.getElementById('cloud_panel').style.display = 'block';
            if(cloudImages[os]) document.getElementById('cloud_url').value = cloudImages[os];
        }
        generate();
    }

    function generate() {
        const name = document.getElementById('vm_name').value || "VM";
        const ram = document.getElementById('ram_val').value;
        const vcpus = document.getElementById('vcpus').value;
        const os = document.getElementById('os_variant').value;
        const disk = document.getElementById('disk_path').value;
        const format = document.getElementById('disk_format').value;
        const size = document.getElementById('disk_size').value;
        const br = document.getElementById('net_br').value;
        const ip = document.getElementById('static_ip').value;
        const graphics = document.querySelector('input[name="graphics"]:checked').value;
        const isCloud = document.getElementById('use_cloud_init').checked;

        document.getElementById('cloud_details').style.display = isCloud ? 'block' : 'none';
        document.getElementById('iso_details').style.display = isCloud ? 'none' : 'block';

        // 1. IP ì˜ˆì•½
        document.getElementById('ip_cmd').value = `virsh net-update default add ip-dhcp-host '<host mac="52:54:00:11:22:33" ip="${ip}"/>' --live --config`;

        // 2. virt-install
        let vCmd = `virt-install \\\n--name ${name} \\\n--ram ${ram} \\\n--vcpus ${vcpus} \\\n--disk path=${disk},size=${size},format=${format} \\\n`;
        if(isCloud) {
            const sshKey = document.getElementById('ssh_key').value;
            vCmd += `--location ${document.getElementById('cloud_url').value} \\\n`;
            let cloudConfig = `user-data={'user':'${document.getElementById('cloud_user').value}','password':'${document.getElementById('cloud_pw').value}'`;
            if(sshKey) cloudConfig += `,'ssh-authorized-keys':['${sshKey}']`;
            cloudConfig += `}`;
            vCmd += `--cloud-init ${cloudConfig} \\\n`;
        } else {
            vCmd += `--location ${document.getElementById('iso_path').value} \\\n`;
        }
        vCmd += `--os-variant ${os} \\\n--network bridge=${br},model=virtio${ip ? ',mac=52:54:00:11:22:33' : ''} \\\n`;
        vCmd += graphics === 'vnc' ? `--graphics vnc,listen=0.0.0.0 \\\n` : `--graphics none \\\n--extra-args 'console=ttyS0,115200n8 serial' \\\n`;
        vCmd += `--console pty,target_type=serial`;
        document.getElementById('virt_cmd').value = vCmd;

        // 3. SSH ìë™ ì ‘ì† ìŠ¤í¬ë¦½íŠ¸
        const user = document.getElementById('cloud_user').value;
        let sCmd = `# VM ë¶€íŒ… ë° SSH ì¤€ë¹„ ëŒ€ê¸° ìŠ¤í¬ë¦½íŠ¸\n`;
        sCmd += `echo "VM(${name})ì˜ SSH í¬íŠ¸ê°€ ì—´ë¦¬ê¸°ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ (IP: ${ip})..."\n`;
        sCmd += `while ! nc -z ${ip} 22; do sleep 2; done\n`;
        sCmd += `echo "SSH ì—°ê²° ì¤€ë¹„ ì™„ë£Œ! ì ‘ì†ì„ ì‹œë„í•©ë‹ˆë‹¤."\n`;
        sCmd += `ssh -o StrictHostKeyChecking=no ${user}@${ip}`;
        document.getElementById('ssh_cmd').value = sCmd;
    }

    function copyText(id) {
        document.getElementById(id).select();
        document.execCommand('copy');
        alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }
    window.onload = onOsChange;
</script>
</body>
</html>
